#include <Arduino.h>
#include <U8g2lib.h> // Include the U8G2 library

// --- U8G2 Object Definition ---
// !! REPLACE with your specific display model and connection type !!
// Example for an I2C 128x64 SSD1306 (commonly used):
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, /* reset=*/ U8X8_PIN_NONE); 
// If you use SPI, it will look different:
// U8G2_SSD1306_128X64_NONAME_F_4W_SW_SPI u8g2(U8G2_R0, /* clock=*/ 13, /* data=*/ 11, /* cs=*/ 10, /* dc=*/ 9, /* reset=*/ 8);


// --- Button Definitions (Adjust to your hardware) ---
#define BTN_UP 5
#define BTN_DOWN 6
#define BTN_SELECT 7
// NOTE: These digital pins (5, 6, 7) must be available on your board.

// --- CORE FUNCTIONALITY FOR LOOPS (Essential for state management) ---

// Global function pointer to hold the current screen's loop function
void (*currentHandler)() = handlemainmenu; 

/**
 * @brief The main execution loop wrapper.
 * This function continuously calls the function currently set as 'currentHandler'.
 */
void runLoop(void (*handler)()) {
  currentHandler = handler;
}

// --- FORWARD DECLARATIONS (Your original list) ---
void handlemainmenu(); // Main menu handler
void loading();        // Placeholder: called before files
void filesetup();      // Placeholder: called before files
// Placeholder handlers for sub-menus
void handleinfraredmenu();
void handlesubghzmenu();
void handlegpiomenu();
void handlenrftoolsmenu();
void handlewifimenu();
void handleblemenu();
void filemenu();
void handleappsmenu();
void handlesettingsmenu();
void handlenfcmenu();
void handlebadusbmenu();

// --- PLACEHOLDER FUNCTIONS (The missing link!) ---

/**
 * @brief Utility screen to show a simple message for a few seconds.
 * @param message The text to display.
 */
void displaySimpleMessage(const char* message, unsigned long duration = 2000) {
  unsigned long startTime = millis();
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_unifont_t_korean); // A standard readable font
  u8g2.drawStr(10, 32, message);
  u8g2.sendBuffer();

  // Wait for duration OR SELECT button press
  while (millis() - startTime < duration) {
    if (digitalRead(BTN_SELECT) == LOW) {
      waitForRelease(BTN_SELECT);
      break;
    }
    delay(50);
  }
}

// --- Placeholder Implementations ---

void loading() {
  displaySimpleMessage("Loading...", 1000);
}

void filesetup() {
  // Add setup code for SD card or file system here.
  // For now, it's just a blank function.
}

// All sub-menu functions simply display a message and return to the main menu
void handleinfraredmenu() {
  displaySimpleMessage("IR Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlesubghzmenu() {
  displaySimpleMessage("SubGHz Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlegpiomenu() {
  displaySimpleMessage("GPIO Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlenrftoolsmenu() {
  displaySimpleMessage("NRF Tools Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlewifimenu() {
  displaySimpleMessage("WiFi Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handleblemenu() {
  displaySimpleMessage("BLE Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void filemenu() {
  displaySimpleMessage("Files Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handleappsmenu() {
  displaySimpleMessage("Apps Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlesettingsmenu() {
  displaySimpleMessage("Settings Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlenfcmenu() {
  displaySimpleMessage("NFC Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

void handlebadusbmenu() {
  displaySimpleMessage("Bad USB Menu: Press SELECT to exit", 5000);
  runLoop(handlemainmenu);
}

// --- YOUR ORIGINAL CODE BLOCK (All your menu data and logic) ---

/* * The following massive block contains all your original code:
 * - Icon Frame Data (infrared_frame0, subghz_frame0, etc.)
 * - Menu Item Names (menuItems)
 * - Icon Arrays (ble_icons, wifi_icons, etc.)
 * - MenuIconSet structure and array (menuIcons)
 * - Menu State Variables (selectedmainmenuIndex, lastAnimTime)
 * - waitForRelease()
 * - drawmainMenu()
 * - handleMenuAction()
 * - handlemainmenu()
 * * I have omitted the *content* here for brevity, but it should be placed right here.
 */

// Your provided data (omitted for brevity, but must be included here):
/* ... */
static const unsigned char infrared_frame0[] U8X8_PROGMEM = {0xf8,0x07,0x06,0x18,0x01,0x20,0xf0,0x03,0x08,0x04,0x00,0x00,0xe0,0x01,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};
// ... (All other frame data, arrays, and functions)
/* ... (Your original code block continues from here) ... */
static const unsigned char infrared_frame1[] U8X8_PROGMEM ={0xf8,0x07,0x06,0x18,0x01,0x20,0xf0,0x03,0x08,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};
static const unsigned char infrared_frame2[] U8X8_PROGMEM = {0xf8,0x07,0x06,0x18,0x01,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};
static const unsigned char infrared_frame3[] U8X8_PROGMEM =  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};
static const unsigned char infrared_frame4[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xe0,0x01,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};
static const unsigned char infrared_frame5[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x03,0x08,0x04,0x00,0x00,0xe0,0x01,0x00,0x00,0x00,0x00,0xe0,0x01,0xf0,0x03,0xf8,0x07,0xf8,0x07,0xff,0x3f};

static const unsigned char subghz_frame0[] U8X8_PROGMEM ={0x04,0x08,0x02,0x10,0x09,0x24,0x05,0x28,0xd5,0x2a,0xd5,0x2a,0x05,0x28,0xc9,0x24,0xc2,0x10,0xc4,0x08,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};
static const unsigned char subghz_frame1[] U8X8_PROGMEM = {0x04,0x08,0x02,0x10,0x09,0x24,0x05,0x28,0xc5,0x28,0xc5,0x28,0x05,0x28,0xc9,0x24,0xc2,0x10,0xc4,0x08,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};
static const unsigned char subghz_frame2[] U8X8_PROGMEM = {0x04,0x08,0x02,0x10,0x01,0x20,0x01,0x20,0xc1,0x20,0xc1,0x20,0x01,0x20,0xc1,0x20,0xc2,0x10,0xc4,0x08,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};
static const unsigned char subghz_frame3[] U8X8_PROGMEM =  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0xc0,0x00,0x00,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};
static const unsigned char subghz_frame4[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xd0,0x02,0xd0,0x02,0x00,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};
static const unsigned char subghz_frame5[] U8X8_PROGMEM = {0x00,0x00,0x00,0x00,0x08,0x04,0x04,0x08,0xd4,0x0a,0xd4,0x0a,0x04,0x08,0xc8,0x04,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00,0xc0,0x00};


static const unsigned char gpio_frame0[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xee,0x0e,0x44,0x04,0x44,0x04,0x44,0x04,0x00,0x00,0xff,0x1f,0x11,0x11,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame1[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xee,0x0e,0x44,0x04,0x44,0x04,0x44,0x04,0xff,0x1f,0x11,0x11,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame2[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xee,0x0e,0x44,0x04,0xff,0x1f,0x55,0x15,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame3[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xff,0x1f,0x55,0x15,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame4[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xff,0x1f,0xff,0x1f,0xff,0x1f,0x11,0x11};
static const unsigned char gpio_frame5[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xff,0x1f,0xff,0x1f,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame6[] U8X8_PROGMEM =  {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xff,0x1f,0x55,0x15,0x55,0x15,0x11,0x11};
static const unsigned char gpio_frame7[] U8X8_PROGMEM = {0x44,0x04,0x44,0x04,0x44,0x04,0x44,0x04,0xee,0x0e,0xee,0x0e,0xee,0x0e,0xee,0x0e,0x44,0x04,0x44,0x04,0xff,0x1f,0x11,0x11,0x55,0x15,0x11,0x11};

static const unsigned char apps_frame0[] U8X8_PROGMEM ={
	0xe7, 0x00, 0xa5, 0x00, 0x99, 0x01, 0x01, 0x02, 0x01, 0x02, 0x81, 0x01, 0x81, 0x0e, 0xe7, 0x08, 
	0x24, 0x18, 0x58, 0x20, 0x40, 0x20, 0x30, 0x18, 0x10, 0x08, 0xf0, 0x0f
};
static const unsigned char apps_frame1[] U8X8_PROGMEM ={
	0x70, 0x0e, 0x50, 0x0a, 0x90, 0x19, 0x10, 0x20, 0x10, 0x20, 0x18, 0x18, 0x1e, 0x08, 0x72, 0x0e, 
	0x46, 0x02, 0x88, 0x05, 0x08, 0x04, 0x06, 0x03, 0x02, 0x01, 0xfe, 0x01
};
static const unsigned char apps_frame2[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0xe4, 0x1c, 0xa7, 0x14, 0x21, 0x33, 0x23, 0x00, 0x24, 0x00, 
	0x24, 0x30, 0x23, 0x10, 0xe1, 0x1c, 0xff, 0x04, 0x00, 0x03, 0x00, 0x00
};
static const unsigned char apps_frame3[] U8X8_PROGMEM ={
	0x30, 0x00, 0x48, 0x00, 0xce, 0x01, 0x02, 0x01, 0x3e, 0x07, 0x28, 0x05, 0xc8, 0x0c, 0x0e, 0x10, 
	0x0a, 0x10, 0x0e, 0x0c, 0x08, 0x04, 0x38, 0x07, 0x20, 0x01, 0xc0, 0x00
};
static const unsigned char apps_frame4[] U8X8_PROGMEM ={
	0x40, 0x02, 0x70, 0x0e, 0x10, 0x08, 0x30, 0x18, 0xce, 0x21, 0x4a, 0x21, 0x32, 0x1b, 0x02, 0x0c, 
	0x02, 0x0c, 0x02, 0x03, 0x02, 0x01, 0xce, 0x01, 0x48, 0x00, 0x30, 0x00
};
static const unsigned char apps_frame5[] U8X8_PROGMEM ={
	0x00, 0x0c, 0x00, 0x12, 0x80, 0x33, 0x80, 0x00, 0xb9, 0x01, 0x29, 0x02, 0x66, 0x02, 0x80, 0x01, 
	0x80, 0x00, 0x60, 0x3f, 0x20, 0x00, 0x39, 0x00, 0x09, 0x00, 0x06, 0x00
};
static const unsigned char apps_frame6[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x06, 0x00, 0x09, 0xf3, 0x39, 0x52, 0x20, 0xcc, 0x20, 0x00, 0x01, 0x00, 0x01, 
	0xc0, 0x20, 0x40, 0x20, 0xf3, 0x3f, 0x12, 0x00, 0x0c, 0x00, 0x00, 0x00
};
static const unsigned char apps_frame7[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x0c, 0x00, 0x12, 0xb9, 0x33, 0xa9, 0x00, 0x66, 0x01, 0x80, 0x02, 0x80, 0x02, 
	0x60, 0x01, 0xa0, 0x00, 0xb9, 0x3f, 0x09, 0x00, 0x06, 0x00, 0x00, 0x00
};

static const unsigned char apps_frame8[] U8X8_PROGMEM ={
	0x00, 0x00, 0x39, 0x00, 0x29, 0x00, 0x66, 0x06, 0x80, 0x09, 0x80, 0x39, 0x60, 0x20, 0xe0, 0x20, 
	0x39, 0x01, 0x09, 0x01, 0xc6, 0x20, 0x40, 0x20, 0xc0, 0x3f, 0x00, 0x00
};

static const unsigned char nfc_frame0[] U8X8_PROGMEM ={
	0x00, 0x08, 0x00, 0x10, 0x00, 0x12, 0x00, 0x22, 0x42, 0x24, 0x87, 0x24, 0x8d, 0x24, 0x99, 0x24, 
	0xf1, 0x24, 0x62, 0x24, 0x00, 0x22, 0x00, 0x12, 0x00, 0x10, 0x00, 0x08
};
static const unsigned char nfc_frame1[] U8X8_PROGMEM ={
	0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x20, 0x42, 0x20, 0x87, 0x20, 0x8d, 0x20, 0x99, 0x20, 
	0xf1, 0x20, 0x62, 0x20, 0x00, 0x20, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08
};
static const unsigned char nfc_frame2[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x87, 0x00, 0x8d, 0x00, 0x99, 0x00, 
	0xf1, 0x00, 0x62, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char nfc_frame3[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x42, 0x04, 0x87, 0x04, 0x8d, 0x04, 0x99, 0x04, 
	0xf1, 0x04, 0x62, 0x04, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00
};

static const unsigned char nfc_frame4[] U8X8_PROGMEM ={
	0x00, 0x08, 0x00, 0x10, 0x00, 0x10, 0x00, 0x20, 0x42, 0x20, 0x87, 0x20, 0x8d, 0x20, 0x99, 0x20, 
	0xf1, 0x20, 0x62, 0x20, 0x00, 0x20, 0x00, 0x10, 0x00, 0x10, 0x00, 0x08
};
static const unsigned char nfc_frame5[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x00, 0x87, 0x00, 0x8d, 0x00, 0x99, 0x00, 
	0xf1, 0x00, 0x62, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char nfc_frame6[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x42, 0x04, 0x87, 0x04, 0x8d, 0x04, 0x99, 0x04, 
	0xf1, 0x04, 0x62, 0x04, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00
};


static const unsigned char badusb_frame0[] U8X8_PROGMEM ={
	0xff, 0x1f, 0x01, 0x10, 0x01, 0x10, 0xf1, 0x11, 0xf9, 0x13, 0xe9, 0x12, 0x49, 0x12, 0xf9, 0x13, 
	0xf1, 0x11, 0x51, 0x11, 0x01, 0x10, 0xff, 0x1f, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame1[] U8X8_PROGMEM ={
	0x01, 0x10, 0x01, 0x10, 0xe1, 0x13, 0xfd, 0x10, 0xf9, 0x13, 0x01, 0x17, 0xf9, 0x13, 0x3d, 0x10, 
	0xf1, 0x11, 0x01, 0x10, 0xff, 0x1f, 0x06, 0x0c, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame2[] U8X8_PROGMEM ={
	0x01, 0x10, 0xf1, 0x11, 0xf9, 0x13, 0x59, 0x13, 0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 
	0x01, 0x10, 0xff, 0x1f, 0x04, 0x04, 0xb6, 0x0d, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame3[] U8X8_PROGMEM ={
	0xf1, 0x11, 0xf9, 0x13, 0x59, 0x13, 0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 0x01, 0x10, 
	0xff, 0x1f, 0x04, 0x04, 0xb4, 0x05, 0x06, 0x0c, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame4[] U8X8_PROGMEM ={
	0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 0x01, 0x10, 0xff, 0x1f, 0x04, 0x04, 0xb4, 0x05, 
	0x04, 0x04, 0xfc, 0x07, 0xfc, 0x07, 0xfe, 0x0f, 0xfe, 0x0f, 0x02, 0x08
};
static const unsigned char badusb_frame5[] U8X8_PROGMEM ={
	0xf1, 0x11, 0x01, 0x10, 0xff, 0x1f, 0x04, 0x04, 0xb4, 0x05, 0x04, 0x04, 0xfc, 0x07, 0xfc, 0x07, 
	0x04, 0x04, 0xfc, 0x07, 0x00, 0x00, 0xfe, 0x0f, 0xfe, 0x0f, 0x02, 0x08
};
static const unsigned char badusb_frame6[] U8X8_PROGMEM ={
	0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 0x01, 0x10, 0xff, 0x1f, 0x04, 0x04, 0xb4, 0x05, 
	0x04, 0x04, 0xfc, 0x07, 0xfc, 0x07, 0xfe, 0x0f, 0xfe, 0x0f, 0x02, 0x08
};
static const unsigned char badusb_frame7[] U8X8_PROGMEM ={
	0xf1, 0x11, 0xf9, 0x13, 0x59, 0x13, 0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 0x01, 0x10, 
	0xff, 0x1f, 0x04, 0x04, 0xb4, 0x05, 0x06, 0x0c, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame8[] U8X8_PROGMEM ={
	0x01, 0x10, 0xf1, 0x11, 0xf9, 0x13, 0x59, 0x13, 0xf9, 0x13, 0xe9, 0x12, 0x19, 0x13, 0xf1, 0x11, 
	0x01, 0x10, 0xff, 0x1f, 0x04, 0x04, 0xb6, 0x0d, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame9[] U8X8_PROGMEM ={
	0x01, 0x10, 0x01, 0x10, 0xe1, 0x13, 0xfd, 0x10, 0xf9, 0x13, 0x01, 0x17, 0xf9, 0x13, 0x3d, 0x10, 
	0xf1, 0x11, 0x01, 0x10, 0xff, 0x1f, 0x06, 0x0c, 0xfe, 0x0f, 0xfe, 0x0f
};
static const unsigned char badusb_frame10[] U8X8_PROGMEM ={
	0xff, 0x1f, 0x01, 0x10, 0x01, 0x10, 0xf1, 0x11, 0xf9, 0x13, 0xe9, 0x12, 0x49, 0x12, 0xf9, 0x13, 
	0xf1, 0x11, 0x51, 0x11, 0x01, 0x10, 0xff, 0x1f, 0xfe, 0x0f, 0xfe, 0x0f
};


static const unsigned char files_frame0[] U8X8_PROGMEM ={
	0xfc, 0x07, 0x04, 0x04, 0xf4, 0x05, 0x04, 0x04, 0xf7, 0x05, 0x05, 0x04, 0xf5, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame1[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0xfc, 0x07, 0x04, 0x04, 0xf7, 0x05, 0x05, 0x04, 0xf5, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame2[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x07, 0x05, 0x04, 0xf5, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame3[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x11, 0x00, 0xfd, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame4[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x11, 0x00, 0xf1, 0x3f, 0x11, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame5[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x11, 0x00, 0xff, 0x07, 0x01, 0x08, 
	0x01, 0x08, 0x01, 0x08, 0x01, 0x08, 0x01, 0x08, 0x01, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame6[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x11, 0x00, 0xf1, 0x3f, 0x11, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame7[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x11, 0x00, 0xfd, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame8[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x07, 0x05, 0x04, 0xf5, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};
static const unsigned char files_frame9[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0xfc, 0x07, 0x04, 0x04, 0xf7, 0x05, 0x05, 0x04, 0xf5, 0x3f, 0x15, 0x20, 
	0x0d, 0x20, 0x0d, 0x10, 0x05, 0x10, 0x05, 0x08, 0x03, 0x08, 0xfe, 0x07
};


static const unsigned char settings_frame1[] U8X8_PROGMEM ={
	0x03, 0x07, 0x87, 0x04, 0x8e, 0x02, 0x9c, 0x32, 0xf8, 0x2c, 0x50, 0x20, 0x30, 0x1e, 0x1e, 0x03, 
	0x81, 0x04, 0xcd, 0x09, 0x53, 0x13, 0x50, 0x26, 0x48, 0x2c, 0x38, 0x18
};
static const unsigned char settings_frame2[] U8X8_PROGMEM ={
	0x03, 0x00, 0x87, 0x03, 0x4e, 0x02, 0x7c, 0x01, 0x48, 0x19, 0x58, 0x16, 0x30, 0x10, 0x10, 0x0f, 
	0x8f, 0x04, 0xc0, 0x09, 0x26, 0x13, 0x29, 0x16, 0x28, 0x0c, 0x24, 0x00
};
static const unsigned char settings_frame3[] U8X8_PROGMEM ={
	0x03, 0x00, 0x07, 0x00, 0xde, 0x01, 0x24, 0x01, 0xac, 0x00, 0xb8, 0x0c, 0x30, 0x0b, 0x10, 0x08, 
	0x88, 0x07, 0xc7, 0x09, 0x20, 0x0b, 0x13, 0x06, 0x14, 0x00, 0x14, 0x00
};
static const unsigned char settings_frame4[] U8X8_PROGMEM ={
	0x04, 0x0c, 0x09, 0x00, 0x13, 0x20, 0x26, 0x20, 0x4c, 0x00, 0xb8, 0x00, 0xa4, 0x00, 0x74, 0x00, 
	0x94, 0x01, 0x64, 0x01, 0x02, 0x01, 0xf1, 0x18, 0x08, 0x38, 0x04, 0x30
};
static const unsigned char settings_frame5[] U8X8_PROGMEM ={
	0x04, 0x0f, 0x89, 0x00, 0x93, 0x26, 0xa6, 0x29, 0x2c, 0x28, 0x18, 0x24, 0x00, 0x1c, 0x0e, 0x00, 
	0x09, 0x00, 0x05, 0x06, 0x65, 0x0e, 0x59, 0x1c, 0x40, 0x38, 0x3c, 0x30
};
static const unsigned char settings_frame6[] U8X8_PROGMEM = {
	0x04, 0x08, 0x05, 0x04, 0xc3, 0x23, 0x20, 0x10, 0xa0, 0x09, 0x60, 0x0a, 0x00, 0x0a, 0x80, 0x09, 
	0x80, 0x07, 0x03, 0x07, 0x02, 0x0e, 0x01, 0x3c, 0x19, 0x08, 0x16, 0x18
};
static const unsigned char settings_frame7[] U8X8_PROGMEM ={
	0x00, 0x14, 0x00, 0x24, 0x00, 0x02, 0x18, 0x31, 0xf8, 0x08, 0x08, 0x04, 0x68, 0x02, 0xd8, 0x02, 
	0x80, 0x06, 0xc0, 0x0a, 0xc0, 0x13, 0x00, 0x26, 0x00, 0x0c, 0x00, 0x18
};
static const unsigned char settings_frame8[] U8X8_PROGMEM ={
	0x00, 0x0a, 0x00, 0x0a, 0x0c, 0x32, 0x1c, 0x01, 0xb8, 0x38, 0x78, 0x04, 0x04, 0x02, 0x34, 0x03, 
	0x4c, 0x05, 0x40, 0x09, 0x20, 0x13, 0xe0, 0x26, 0x00, 0x0c, 0x00, 0x18
};
static const unsigned char settings_frame9[] U8X8_PROGMEM ={
	0x00, 0x09, 0x06, 0x05, 0x0e, 0x25, 0x1c, 0x19, 0xb8, 0x00, 0x70, 0x3c, 0x3c, 0x02, 0x02, 0x03, 
	0x9a, 0x04, 0xa6, 0x09, 0xa0, 0x13, 0x90, 0x26, 0x70, 0x0c, 0x00, 0x18
};
static const unsigned char settings_frame10[] U8X8_PROGMEM ={
	0x03, 0x07, 0x87, 0x04, 0x8e, 0x02, 0x9c, 0x32, 0xf8, 0x2c, 0x50, 0x20, 0x30, 0x1e, 0x1e, 0x03, 
	0x81, 0x04, 0xcd, 0x09, 0x53, 0x13, 0x50, 0x26, 0x48, 0x2c, 0x38, 0x18
};


static const unsigned char nrftools_frame1[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x1e, 0x0c, 0x20, 0x34, 0x4c, 0xc6, 0x50, 0x15, 0x57, 0x49, 0x45, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};
static const unsigned char nrftools_frame2[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x34, 0x0c, 0xc6, 0x10, 0x15, 0x17, 0x49, 0x05, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};
static const unsigned char nrftools_frame3[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x1e, 0x0c, 0x20, 0x34, 0x40, 0xc6, 0x40, 0x15, 0x47, 0x49, 0x45, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};
static const unsigned char nrftools_frame4[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x34, 0x00, 0xc6, 0x00, 0x15, 0x07, 0x49, 0x05, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};
static const unsigned char nrftools_frame5[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x34, 0x0c, 0xc6, 0x10, 0x15, 0x17, 0x49, 0x05, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};
static const unsigned char nrftools_frame6[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x1e, 0x0c, 0x20, 0x34, 0x40, 0xc6, 0x40, 0x15, 0x47, 0x49, 0x45, 0x09, 0x07, 
	0x91, 0x08, 0x51, 0x12, 0x22, 0x10, 0xc2, 0x24, 0x04, 0x23, 0x0c, 0x3c, 0x30, 0x08, 0xc0, 0x07
};


static const unsigned char ble_frame1[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x08, 0x11, 0x11, 0x12, 0x25, 0x94, 0x28, 0x58, 0x2a, 0x30, 0x29, 
	0x58, 0x2a, 0x94, 0x28, 0x12, 0x25, 0x11, 0x11, 0x90, 0x08, 0x50, 0x00, 0x20, 0x00
};
static const unsigned char ble_frame2[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x00, 0x11, 0x01, 0x12, 0x01, 0x94, 0x00, 0x58, 0x02, 0x30, 0x01, 
	0x58, 0x02, 0x94, 0x00, 0x12, 0x01, 0x11, 0x01, 0x90, 0x00, 0x50, 0x00, 0x20, 0x00
};
static const unsigned char ble_frame3[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x00, 0x11, 0x01, 0x12, 0x05, 0x94, 0x08, 0x58, 0x0a, 0x30, 0x09, 
	0x58, 0x0a, 0x94, 0x08, 0x12, 0x05, 0x11, 0x01, 0x90, 0x00, 0x50, 0x00, 0x20, 0x00
};
static const unsigned char ble_frame4[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x00, 0x11, 0x01, 0x12, 0x01, 0x94, 0x00, 0x58, 0x00, 0x30, 0x00, 
	0x58, 0x00, 0x94, 0x00, 0x12, 0x01, 0x11, 0x01, 0x90, 0x00, 0x50, 0x00, 0x20, 0x00
};
static const unsigned char ble_frame5[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x08, 0x11, 0x11, 0x12, 0x25, 0x94, 0x28, 0x58, 0x2a, 0x30, 0x29, 
	0x58, 0x2a, 0x94, 0x28, 0x12, 0x25, 0x11, 0x11, 0x90, 0x08, 0x50, 0x00, 0x20, 0x00
};
static const unsigned char ble_frame6[] U8X8_PROGMEM ={
	0x20, 0x00, 0x50, 0x00, 0x90, 0x00, 0x11, 0x01, 0x12, 0x01, 0x94, 0x00, 0x58, 0x02, 0x30, 0x01, 
	0x58, 0x02, 0x94, 0x00, 0x12, 0x01, 0x11, 0x01, 0x90, 0x00, 0x50, 0x00, 0x20, 0x00
};


static const unsigned char wifi_frame1[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x04, 0x04, 0xf2, 0x09, 0x08, 0x02, 0xe0, 0x00, 
	0x10, 0x01, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char wifi_frame2[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x04, 0x04, 0xf2, 0x09, 0x08, 0x02, 0x00, 0x00, 
	0x00, 0x00, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char wifi_frame3[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x04, 0x04, 0x02, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char wifi_frame4[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const unsigned char wifi_frame5[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x04, 0x04, 0xf2, 0x09, 0x08, 0x02, 0xe0, 0x00, 
	0x10, 0x01, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};
static const unsigned char wifi_frame6[] U8X8_PROGMEM ={
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x03, 0x04, 0x04, 0xf2, 0x09, 0x08, 0x02, 0x00, 0x00, 
	0x00, 0x00, 0x40, 0x00, 0xa0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const unsigned char image_scroll_indicator_bits[] U8X8_PROGMEM = {0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00};
static const unsigned char image_selection_bar_bits[] U8X8_PROGMEM =  {
	0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 
	0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 
	0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
	0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00
};
// End of data block

// Menu Item Names
const char* menuItems[] = {
  "infrared", "subghz", "gpio",
  "nrf tools", "wifi", "ble",
  "files", "apps", "settings",
  "nfc", "bad usb"
};
const int MENU_LEN = sizeof(menuItems) / sizeof(menuItems[0]);

// Icon animation arrays
const unsigned char* ble_icons[] = {
    ble_frame1,ble_frame2,ble_frame3,
    ble_frame4,ble_frame5,ble_frame6
};


const unsigned char* wifi_icons[] = {
wifi_frame1,wifi_frame2,wifi_frame3,
wifi_frame4,wifi_frame5,wifi_frame6

};

const unsigned char* nrftools_icons[] = {
  nrftools_frame1,nrftools_frame2,nrftools_frame3,
  nrftools_frame4,nrftools_frame5,nrftools_frame6
};


const unsigned char* settings_icons[] = {
  settings_frame1,settings_frame2,settings_frame3,
  settings_frame4,settings_frame5,settings_frame6,
  settings_frame7,settings_frame8,settings_frame9,
  settings_frame10,

};



const unsigned char* files_icons[] = {
files_frame0,files_frame1,files_frame2,
files_frame3,files_frame4,files_frame5,
files_frame6,files_frame7,files_frame8,
files_frame9

};

const unsigned char* badusb_icons[] = {
  badusb_frame0,badusb_frame1,badusb_frame2,
  badusb_frame3,badusb_frame4,badusb_frame5,
  badusb_frame6,badusb_frame7,badusb_frame8,
  badusb_frame9,badusb_frame10
};


const unsigned char* infrared_icons[] = {
  infrared_frame0, infrared_frame1, infrared_frame2,
  infrared_frame3, infrared_frame4, infrared_frame5
};
const unsigned char* subghz_icons[] = {
  subghz_frame0, subghz_frame1, subghz_frame2,
  subghz_frame3, subghz_frame4, subghz_frame5
};
const unsigned char* gpio_icons[] = {
  gpio_frame0, gpio_frame1, gpio_frame2,
  gpio_frame3, gpio_frame4, gpio_frame5,
  gpio_frame6, gpio_frame7
};

const unsigned char* apps_icons[] = {
apps_frame0,apps_frame1,apps_frame2,
apps_frame3,apps_frame4,apps_frame5,
apps_frame6,apps_frame7,apps_frame8
};


const unsigned char* nfc_icons[] = {
  nfc_frame0,nfc_frame1,nfc_frame2,nfc_frame3
  ,nfc_frame4,nfc_frame5,nfc_frame6

};


// Structure to hold all icon sets
struct MenuIconSet {
  const unsigned char** frames;
  int frameCount;
};

// Menu Icons Array (MUST match menuItems order)
MenuIconSet menuIcons[] = {
  {infrared_icons, 6},   // 0: infrared
  {subghz_icons, 6},     // 1: subghz
  {gpio_icons, 8},       // 2: gpio
  {nrftools_icons, 6},   // 3: nrf tools
  {wifi_icons, 6},       // 4: wifi
  {ble_icons, 6},        // 5: ble
  {files_icons, 10},     // 6: files
  {apps_icons, 9},       // 7: apps
  {settings_icons, 10},  // 8: settings
  {nfc_icons, 7},        // 9: nfc (Corrected count to 7)
  {badusb_icons, 11},    // 10: bad usb
};


// Menu State Variables
int selectedmainmenuIndex = 0;
unsigned long lastAnimTime = 0;
const unsigned long animInterval = 100; // Faster animation speed


/**
 * @brief Waits until the specified button is released.
 * @param pin The button pin to check.
 */
void waitForRelease(uint8_t pin) {
  // Assuming buttons are pulled up and LOW when pressed
  while (digitalRead(pin) == LOW) {
    delay(5); // Debounce delay while held
  }
}


/**
 * @brief Draws the main carousel menu.
 */
void drawmainMenu() {
  u8g2.clearBuffer();
  u8g2.setBitmapMode(1);
  u8g2.setFontMode(1);
  u8g2.setDrawColor(1); // Default draw color to white

  // --- Scroll Indicator & Position Box ---
  
  // Draw position box (Scroll Indicator, 3xH box)
  // Constraint: Ensure box is at least 2 pixels tall
  int boxHeight = constrain(64 / MENU_LEN, 2, 64); 
  // Map index to Y position (0 to 64 - boxHeight)
  int boxY = map(selectedmainmenuIndex, 0, MENU_LEN - 1, 0, 64 - boxHeight);
  u8g2.drawBox(125, boxY, 3, boxHeight);
  
  // Draw static scroll track line (Vertical line at the edge)
  u8g2.drawVLine(126, 0, 64);
  
  // Draw the selection bar graphic (122x23) centered at y=20
  u8g2.drawXBMP(0, 20, 122, 23, image_selection_bar_bits);

  // --- Draw Menu Items (Previous, Current, Next) ---
  for (int i = -1; i <= 1; i++) {
    int itemIndex = (selectedmainmenuIndex + i + MENU_LEN) % MENU_LEN;
    int yOffset = 22 + (i * 22); // Center y=22, Up y=0, Down y=44
    int textY = yOffset + 14;
    int iconX = 12; // Icon is placed at X=12
    int iconY = yOffset + 3;
    bool isSelected = (i == 0);

    const MenuIconSet& iconSet = menuIcons[itemIndex];
    const unsigned char* icon;
    
    // Determine icon frame (Animated if selected, static frame 0 if not)
    if (isSelected) {
        int frameIndex = (millis() / animInterval) % iconSet.frameCount;
        icon = iconSet.frames[frameIndex];
    } else {
        icon = iconSet.frames[0];
    }

    // Set draw color based on selection status (Invert color on selection bar)
    if (isSelected) {
        u8g2.setDrawColor(0); // 0 = Black (or inverted for monochrome)
    } else {
        u8g2.setDrawColor(1); // 1 = White (default)
    }
    
    // Draw Icon (14x14)
    // NOTE: Icon size is usually 14x14 or 16x16, your XBMP draw call is missing size.
    // Assuming 16x16 or a size compatible with your bitmap data structure (28 bytes)
    u8g2.drawXBMP(iconX, iconY, 16, 16, icon); // Using 16x16 as a common icon size
    
    // Draw Text
    u8g2.setFont(isSelected ? u8g2_font_t0_15b_tr : u8g2_font_t0_14_tr);
    u8g2.drawStr(35, textY, menuItems[itemIndex]);
    
    u8g2.setDrawColor(1); // Reset draw color to default white for next iteration
  }

  u8g2.sendBuffer();
}


/**
 * @brief Dispatches the action when the SELECT button is pressed.
 * @param index The index of the selected menu item.
 */
void handleMenuAction(int index) {
  switch (index) {
    case 0: // infrared
      runLoop(handleinfraredmenu);
      break;
    case 1: // subghz (FIXED: was incorrectly calling handlenfcmenu)
      runLoop(handlesubghzmenu);
      break;
    case 2: // gpio
      runLoop(handlegpiomenu);
      break;
    case 3: // nrf tools
      runLoop(handlenrftoolsmenu);
      break;
    case 4: // wifi
      runLoop(handlewifimenu);
      break;
    case 5: // ble
      runLoop(handleblemenu);
      break;
    case 6: // files
      filesetup();
      loading();
      runLoop(filemenu);
      break;
    case 7: // apps
      runLoop(handleappsmenu);
      break;
    case 8: // settings
      runLoop(handlesettingsmenu);
      break;
    case 9: // nfc
      runLoop(handlenfcmenu);
      break;
    case 10: // bad usb
      runLoop(handlebadusbmenu);
      break;
  }
}


/**
 * @brief Main loop handler for the menu system.
 */
void handlemainmenu() {
  static unsigned long lastButtonTime = 0;
  const unsigned long buttonDebounce = 200; // Debounce time for button presses

  // Animation update timer
  if (millis() - lastAnimTime > animInterval) {
    lastAnimTime = millis();
  }

  drawmainMenu();

  // Button handling with debounce
  if (millis() - lastButtonTime > buttonDebounce) {
    if (digitalRead(BTN_UP) == LOW) {
      selectedmainmenuIndex = (selectedmainmenuIndex - 1 + MENU_LEN) % MENU_LEN;
      lastButtonTime = millis();
      waitForRelease(BTN_UP); // Wait for button release
    } else if (digitalRead(BTN_DOWN) == LOW) {
      selectedmainmenuIndex = (selectedmainmenuIndex + 1) % MENU_LEN;
      lastButtonTime = millis();
      waitForRelease(BTN_DOWN); // Wait for button release
    } else if (digitalRead(BTN_SELECT) == LOW) {
      handleMenuAction(selectedmainmenuIndex);
      lastButtonTime = millis();
      waitForRelease(BTN_SELECT); // Wait for button release
    }
  }
}
// --- END OF YOUR ORIGINAL CODE BLOCK ---

// --- ARDUINO BOILERPLATE FUNCTIONS ---

void setup() {
  // 1. Initialize display (Crucial for U8G2)
  u8g2.begin();
  u8g2.setFlipMode(0); // Standard flip
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_unifont_t_korean);
  u8g2.drawStr(0, 15, "Display Initialized!");
  u8g2.drawStr(0, 30, "Ready to Hack.");
  u8g2.sendBuffer();
  delay(1000); // Startup screen pause

  // 2. Initialize buttons
  pinMode(BTN_UP, INPUT_PULLUP);    // Assuming pull-up resistors (press = LOW)
  pinMode(BTN_DOWN, INPUT_PULLUP);  // Change to INPUT if using external pull-downs
  pinMode(BTN_SELECT, INPUT_PULLUP); 
}

void loop() {
  // The magic is here: call the function currently set as the handler.
  currentHandler(); 
}
